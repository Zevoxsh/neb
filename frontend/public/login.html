<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Nebula Console</title>
  <link rel="stylesheet" href="/public/nebula-v2.css">
  <script src="/public/js/theme.js"></script>
  <script src="/public/js/api.js" defer></script>
</head>

<body class="login-shell">
  <div class="login-card">
    <div class="login-brand">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.8L20 8v8l-8 4-8-4V8l8-3.2z" />
      </svg>
      <h1>NEBULA</h1>
    </div>

    <p class="login-description">Sign in to your control plane</p>

    <form id="loginForm">
      <div class="form-field">
        <label for="loginUser">Username</label>
        <input
          id="loginUser"
          name="username"
          type="text"
          autocomplete="username"
          value="admin"
          required
          autofocus>
      </div>

      <div class="form-field">
        <label for="loginPass">Password</label>
        <input
          id="loginPass"
          name="password"
          type="password"
          autocomplete="current-password"
          required>
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" id="btnLogin" type="submit">
          Sign In
        </button>
      </div>

      <div id="loginError" class="login-error" hidden>
        Invalid credentials. Please try again.
      </div>
    </form>

    <p class="login-footer">
      Need help? Check default credentials in your <code>.env</code> file.
    </p>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('loginForm');
      const btn = document.getElementById('btnLogin');
      const errorBox = document.getElementById('loginError');
      const params = new URLSearchParams(window.location.search);
      const nextUrl = params.get('next') || '/dashboard.html';

      async function attemptLogin(ev) {
        ev.preventDefault();
        errorBox.hidden = true;
        btn.disabled = true;
        btn.textContent = 'Signing in...';

        const username = document.getElementById('loginUser').value.trim();
        const password = document.getElementById('loginPass').value;

        const res = await window.api.requestJson('/api/login', {
          method: 'POST',
          body: { username, password },
          skipAuthRedirect: true
        });

        btn.disabled = false;
        btn.textContent = 'Sign In';

        if (res && res.status === 200) {
          window.location.href = nextUrl;
        } else {
          errorBox.textContent = 'Unable to login. Please check your credentials.';
          errorBox.hidden = false;
        }
      }

      form.addEventListener('submit', attemptLogin);

      (async () => {
        const check = await window.api.requestJson('/profile', {
          headers: { Accept: 'application/json' },
          skipAuthRedirect: true
        });
        if (check && check.status === 200) {
          window.location.href = nextUrl;
        }
      })();
    });
  </script>
</body>
</html>
