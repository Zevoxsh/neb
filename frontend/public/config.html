<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - Nebula Proxy</title>
    <link rel="stylesheet" href="/public/styles.css">
    <style>
        .config-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .config-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }

        .config-tab:hover {
            color: var(--text-main);
        }

        .config-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .config-section {
            display: none;
        }

        .config-section.active {
            display: block;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .config-item label {
            display: block;
            color: var(--text-main);
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .config-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: var(--bg-deep);
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-weight: 600;
            display: none;
            animation: slideIn 0.3s;
            z-index: 1000;
        }

        .save-indicator.success {
            background: var(--success);
        }

        .save-indicator.error {
            background: var(--danger);
            color: #fff;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .db-alert {
            background: rgba(255, 51, 51, 0.1);
            border: 1px solid var(--danger);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            margin-bottom: 24px;
            display: none;
            align-items: center;
            gap: 12px;
        }

        .db-alert.show {
            display: flex;
        }

        .db-alert-icon {
            font-size: 24px;
        }

        .db-alert-content {
            flex: 1;
        }

        .db-alert-title {
            color: var(--danger);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .db-alert-message {
            color: var(--text-muted);
            font-size: 14px;
        }

        .db-alert-actions {
            display: flex;
            gap: 8px;
        }
    </style>
</head>
<body data-page="config">
    <div class="app-shell">
        <div id="sidebar-placeholder"></div>
        <div class="app-main">
            <header class="topbar">
                <div class="page-heading">
                    <p class="eyebrow">Syst√®me</p>
                    <h1>Configuration</h1>
                    <p class="muted">Gestion centralis√©e de tous les param√®tres</p>
                </div>
                <div class="topbar-actions">
                    <button onclick="exportEnv()" class="btn ghost">üì• Exporter .env</button>
                    <button onclick="saveAll()" class="btn">üíæ Sauvegarder Tout</button>
                    <button onclick="restartApp()" class="btn ghost" id="restartBtn" style="display: none;">üîÑ Red√©marrer</button>
                </div>
            </header>
            
            <section class="page-content">
                <div id="dbAlert" class="db-alert">
                    <div class="db-alert-icon">‚ö†Ô∏è</div>
                    <div class="db-alert-content">
                        <div class="db-alert-title">Connexion √† la base de donn√©es √©chou√©e</div>
                        <div class="db-alert-message" id="dbAlertMessage">Impossible de se connecter √† la base de donn√©es PostgreSQL</div>
                    </div>
                    <div class="db-alert-actions">
                        <button onclick="testDatabaseConnection()" class="btn ghost" id="testDbBtn">üîå Tester la connexion</button>
                    </div>
                </div>
                <div class="config-tabs" id="categoryTabs"></div>
                <div id="categoryContent"></div>
            </section>
            
            <div id="footer-placeholder"></div>
        </div>
    </div>

    <div id="saveIndicator" class="save-indicator"></div>

    <script src="/public/js/include-partials.js"></script>
    <script src="/public/js/api.js"></script>
    <script>
        let configData = {};
        let configSchema = {};
        let unsavedChanges = new Set();

        // Wait for api.js to load
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                loadConfig();
                checkDatabaseConnection();
            }, 100);
        });

        async function checkDatabaseConnection() {
            try {
                if (typeof api === 'undefined') {
                    setTimeout(checkDatabaseConnection, 200);
                    return;
                }

                const response = await fetch('/api/config/test-db', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const result = await response.json();
                
                if (!result.success) {
                    showDatabaseAlert(result.error || 'Connexion √† la base de donn√©es √©chou√©e');
                } else {
                    hideDatabaseAlert();
                }
            } catch (error) {
                console.error('Failed to check database:', error);
                showDatabaseAlert('Impossible de v√©rifier la connexion √† la base de donn√©es');
            }
        }

        function showDatabaseAlert(message) {
            const alert = document.getElementById('dbAlert');
            const messageEl = document.getElementById('dbAlertMessage');
            messageEl.textContent = message;
            alert.classList.add('show');
        }

        function hideDatabaseAlert() {
            const alert = document.getElementById('dbAlert');
            alert.classList.remove('show');
        }

        async function testDatabaseConnection() {
            const btn = document.getElementById('testDbBtn');
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Test en cours...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/config/test-db', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const result = await response.json();
                
                if (result.success) {
                    hideDatabaseAlert();
                    showNotification('‚úì Connexion √† la base de donn√©es r√©ussie', 'success');
                } else {
                    showDatabaseAlert(result.error || 'Connexion √©chou√©e');
                    showNotification('Connexion √©chou√©e: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Test failed:', error);
                showNotification('Erreur lors du test de connexion', 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function loadConfig() {
            try {
                if (typeof api === 'undefined') {
                    console.error('API not loaded yet, retrying...');
                    setTimeout(loadConfig, 200);
                    return;
                }
                
                const data = await api.get('/api/config');
                configData = data.config;
                configSchema = data.schema;
                renderConfig();
            } catch (error) {
                console.error('Failed to load config:', error);
                showNotification('Erreur de chargement de la configuration', 'error');
            }
        }

        function renderConfig() {
            const categories = Object.keys(configSchema);
            
            const tabsHtml = categories.map(cat => `
                <button class="config-tab ${cat === categories[0] ? 'active' : ''}" 
                        onclick="switchCategory('${cat}')">
                    ${getCategoryIcon(cat)} ${getCategoryLabel(cat)}
                </button>
            `).join('');
            document.getElementById('categoryTabs').innerHTML = tabsHtml;

            const contentHtml = categories.map(cat => `
                <article class="card config-section ${cat === categories[0] ? 'active' : ''}" 
                     id="category-${cat}">
                    <div class="card-header">
                        <div>
                            <p class="eyebrow">${getCategoryLabel(cat)}</p>
                            <h2>Configuration</h2>
                        </div>
                        <button class="btn ghost small" onclick="resetCategory('${cat}')">
                            üîÑ R√©initialiser
                        </button>
                    </div>
                    <div class="config-grid">
                        ${renderCategoryFields(cat)}
                    </div>
                </article>
            `).join('');
            document.getElementById('categoryContent').innerHTML = contentHtml;
        }

        function renderCategoryFields(category) {
            const fields = configSchema[category];
            
            // Message sp√©cial pour la base de donn√©es
            let headerMessage = '';
            if (category === 'database') {
                headerMessage = `
                    <div class="alert alert-info" style="margin-bottom: 20px;">
                        ‚ÑπÔ∏è Ces param√®tres modifient le fichier <code>.env</code>. Un red√©marrage de l'application sera n√©cessaire apr√®s la sauvegarde.
                    </div>
                `;
            }
            
            const fieldsHtml = Object.entries(fields).map(([key, schema]) => {
                const value = configData[category][key];
                const fieldId = `${category}.${key}`;
                const required = schema.required ? '*' : '';

                let inputHtml = '';
                if (schema.type === 'boolean') {
                    inputHtml = `
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="${fieldId}" ${value ? 'checked' : ''}
                                   onchange="markChanged('${category}', '${key}', this.checked, ${schema.requiresRestart || false})">
                            <span>${getFieldLabel(key)}</span>
                        </label>
                    `;
                } else if (schema.type === 'password') {
                    inputHtml = `
                        <label>${getFieldLabel(key)}${required}</label>
                        <input type="password" id="${fieldId}" value="${value || ''}" 
                               placeholder="${schema.default}"
                               onchange="markChanged('${category}', '${key}', this.value, ${schema.requiresRestart || false})">
                    `;
                } else if (schema.type === 'number') {
                    const unit = schema.unit ? ` ${schema.unit}` : '';
                    inputHtml = `
                        <label>${getFieldLabel(key)}${required}</label>
                        <input type="number" id="${fieldId}" value="${value || schema.default}"
                               min="${schema.min || 0}" max="${schema.max || 999999}"
                               onchange="markChanged('${category}', '${key}', Number(this.value), ${schema.requiresRestart || false})"
                               placeholder="${schema.default}${unit}">
                    `;
                } else if (schema.type === 'array') {
                    inputHtml = `
                        <label>${getFieldLabel(key)}${required}</label>
                        <input type="text" id="${fieldId}" 
                               value="${Array.isArray(value) ? value.join(', ') : ''}"
                               placeholder="Valeurs s√©par√©es par des virgules"
                               onchange="markChanged('${category}', '${key}', this.value.split(',').map(v => v.trim()), ${schema.requiresRestart || false})">
                    `;
                } else {
                    inputHtml = `
                        <label>${getFieldLabel(key)}${required}</label>
                        <input type="text" id="${fieldId}" value="${value || ''}" 
                               placeholder="${schema.default}"
                               onchange="markChanged('${category}', '${key}', this.value, ${schema.requiresRestart || false})">
                    `;
                }

                return `
                    <div class="config-item">
                        ${inputHtml}
                        ${getHelpText(key, schema)}
                    </div>
                `;
            }).join('');
            
            return headerMessage + fieldsHtml;
        }

        function switchCategory(category) {
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.config-section').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`category-${category}`).classList.add('active');
        }

        function markChanged(category, key, value, requiresRestart = false) {
            configData[category][key] = value;
            const changeKey = `${category}.${key}`;
            unsavedChanges.add(changeKey);
            
            // Marquer si n√©cessite red√©marrage
            if (requiresRestart) {
                if (!window.changesRequiringRestart) {
                    window.changesRequiringRestart = new Set();
                }
                window.changesRequiringRestart.add(changeKey);
            }
            
            clearTimeout(window.autoSaveTimer);
            window.autoSaveTimer = setTimeout(() => {
                saveChanges(category, key, value, requiresRestart);
            }, 1000);
        }

        async function saveChanges(category, key, value, requiresRestart = false) {
            try {
                if (requiresRestart) {
                    // Sauvegarder dans le .env
                    const updates = {};
                    updates[key] = value;
                    
                    await fetch('/api/config/update-env', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ category, updates })
                    });
                    
                    unsavedChanges.delete(`${category}.${key}`);
                    showNotification('‚úì Sauvegard√© dans .env - Red√©marrage requis', 'success');
                } else {
                    // Sauvegarder en DB (comportement normal)
                    await api.put('/api/config', { category, key, value });
                    unsavedChanges.delete(`${category}.${key}`);
                    showNotification('‚úì Sauvegard√©', 'success');
                }
            } catch (error) {
                console.error('Failed to save:', error);
                showNotification('Erreur de sauvegarde', 'error');
            }
        }

        async function saveAll() {
            if (unsavedChanges.size === 0) {
                showNotification('Aucun changement √† sauvegarder', 'success');
                return;
            }

            const dbUpdates = [];
            const envUpdatesByCategory = {};
            let hasEnvChanges = false;
            
            // S√©parer les changements DB vs .env
            for (const changeKey of unsavedChanges) {
                const [category, field] = changeKey.split('.');
                const schema = configSchema[category]?.[field];
                
                if (schema?.requiresRestart) {
                    if (!envUpdatesByCategory[category]) {
                        envUpdatesByCategory[category] = {};
                    }
                    envUpdatesByCategory[category][field] = configData[category][field];
                    hasEnvChanges = true;
                } else {
                    dbUpdates.push({
                        category,
                        key: field,
                        value: configData[category][field]
                    });
                }
            }

            try {
                // Sauvegarder les changements .env par cat√©gorie
                for (const [category, updates] of Object.entries(envUpdatesByCategory)) {
                    await fetch('/api/config/update-env', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ category, updates })
                    });
                }
                
                // Sauvegarder les changements DB
                if (dbUpdates.length > 0) {
                    await api.post('/api/config/bulk', { updates: dbUpdates });
                }
                
                unsavedChanges.clear();
                
                if (hasEnvChanges) {
                    showNotification(`‚úì Fichier .env mis √† jour - RED√âMARRAGE REQUIS`, 'success');
                    document.getElementById('restartBtn').style.display = 'block';
                } else {
                    showNotification(`‚úì ${dbUpdates.length} param√®tres sauvegard√©s`, 'success');
                }
            } catch (error) {
                console.error('Failed to save all:', error);
                showNotification('Erreur de sauvegarde', 'error');
            }
        }

        async function restartApp() {
            if (!confirm('Red√©marrer l\'application maintenant ? Cela peut prendre quelques secondes.')) {
                return;
            }
            
            showNotification('Red√©marrage en cours...', 'success');
            
            try {
                await fetch('/api/system/restart', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                // Attendre quelques secondes puis recharger
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } catch (error) {
                showNotification('Veuillez red√©marrer manuellement l\'application', 'error');
            }
        }

        async function resetCategory(category) {
            if (!confirm(`R√©initialiser tous les param√®tres de ${getCategoryLabel(category)} ?`)) {
                return;
            }

            try {
                await api.post('/api/config/reset', { category });
                await loadConfig();
                showNotification('‚úì R√©initialis√©', 'success');
            } catch (error) {
                console.error('Failed to reset:', error);
                showNotification('Erreur', 'error');
            }
        }

        async function exportEnv() {
            window.location.href = '/api/config/export';
        }

        function showNotification(message, type = 'success') {
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = message;
            indicator.className = `save-indicator ${type}`;
            indicator.style.display = 'block';
            
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        function getCategoryIcon(category) {
            const icons = {
                database: 'üóÑÔ∏è',
                security: 'üîí',
                acme: 'üîê',
                botProtection: 'üõ°Ô∏è',
                backends: 'üñ•Ô∏è',
                alerts: 'üö®',
                ipSecurity: 'üö´',
                metrics: 'üìä'
            };
            return icons[category] || '‚öôÔ∏è';
        }

        function getCategoryLabel(category) {
            const labels = {
                database: 'Base de Donn√©es',
                security: 'S√©curit√© & JWT',
                acme: 'SSL / Let\'s Encrypt',
                botProtection: 'Protection Bot / DDoS',
                backends: 'Backends & Health Check',
                alerts: 'Alertes',
                ipSecurity: 'S√©curit√© IP',
                metrics: 'M√©triques'
            };
            return labels[category] || category;
        }

        function getFieldLabel(key) {
            const labels = {
                host: 'H√¥te',
                port: 'Port',
                user: 'Utilisateur',
                password: 'Mot de passe',
                name: 'Nom de la base',
                jwtSecret: 'Secret JWT',
                cookieSecure: 'Cookie s√©curis√© (HTTPS)',
                botSecret: 'Secret Bot Protection',
                email: 'Email ACME',
                localTlds: 'TLDs locaux',
                enabled: 'Activ√©',
                threshold: 'Seuil global (req/s)',
                perIpLimit: 'Limite par IP (req/min)',
                perIpLimitProtected: 'Limite domaines prot√©g√©s (req/min)',
                verifiedIpLimit: 'Limite IP v√©rifi√©es (req/min)',
                burstLimit: 'Limite burst (req/10s)',
                maxConnectionsPerIP: 'Connexions max par IP',
                maxAttempts: 'Tentatives max challenge',
                verificationDuration: 'Dur√©e v√©rification',
                challengeFirstVisit: 'Challenge 1√®re visite',
                healthCheckInterval: 'Intervalle health check',
                failureThreshold: 'Seuil d\'√©checs',
                healthCheckTimeout: 'Timeout health check',
                cooldown: 'D√©lai entre alertes',
                autoBlockIps: 'Blocage auto IPs',
                ipBytesThreshold: 'Seuil bytes par IP',
                ipRequestsThreshold: 'Seuil requ√™tes par IP',
                flushInterval: 'Intervalle flush m√©triques',
                maxBufferSize: 'Taille max buffer'
            };
            return labels[key] || key;
        }

        function getHelpText(key, schema) {
            const helps = {
                jwtSecret: 'Au moins 32 caract√®res al√©atoires',
                perIpLimit: 'Limite pour IPs non v√©rifi√©es',
                verifiedIpLimit: 'Limite plus √©lev√©e apr√®s challenge',
                verificationDuration: 'Dur√©e de validit√© apr√®s challenge r√©ussi',
                localTlds: 'Domaines locaux qui ne g√©n√®rent pas de certificat'
            };
            
            let text = helps[key] || '';
            if (schema.min !== undefined || schema.max !== undefined) {
                text += ` (${schema.min || 0} - ${schema.max || '‚àû'})`;
            }
            
            return text ? `<small class="muted">${text}</small>` : '';
        }

        window.addEventListener('beforeunload', (e) => {
            if (unsavedChanges.size > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
