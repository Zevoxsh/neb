<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - Nebula Proxy</title>
    <link rel="stylesheet" href="/public/styles.css">
    <style>
        .config-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .config-actions {
            display: flex;
            gap: 10px;
        }

        .category-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 12px 24px;
            background: #1a1a1a;
            border: none;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .category-tab:hover {
            background: #222;
            color: #fff;
        }

        .category-tab.active {
            background: #2a2a2a;
            color: #00d4ff;
            border-bottom: 2px solid #00d4ff;
        }

        .category-content {
            display: none;
            background: #1a1a1a;
            padding: 30px;
            border-radius: 8px;
        }

        .category-content.active {
            display: block;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .config-item {
            background: #0a0a0a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .config-item label {
            display: block;
            color: #00d4ff;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .config-item input,
        .config-item select {
            width: 100%;
            padding: 10px;
            background: #000;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }

        .config-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .config-item input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .config-item .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .config-item .value-unit {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .config-item .value-unit input {
            flex: 1;
        }

        .config-item .value-unit span {
            color: #888;
            font-size: 12px;
            min-width: 60px;
        }

        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #00d4ff;
            color: #000;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            display: none;
            animation: slideIn 0.3s;
        }

        .save-indicator.success {
            background: #00ff88;
        }

        .save-indicator.error {
            background: #ff4444;
            color: #fff;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .reset-btn {
            background: #ff4444;
            color: #fff;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .reset-btn:hover {
            background: #cc0000;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .category-header h3 {
            color: #fff;
            margin: 0;
        }

        .required-field::after {
            content: '*';
            color: #ff4444;
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <div class="config-container">
        <div class="config-header">
            <div>
                <h1>‚öôÔ∏è Configuration Syst√®me</h1>
                <p style="color: #888;">Gestion centralis√©e de tous les param√®tres</p>
            </div>
            <div class="config-actions">
                <button onclick="exportEnv()" class="btn btn-secondary">
                    üì• Exporter .env
                </button>
                <button onclick="saveAll()" class="btn btn-primary">
                    üíæ Sauvegarder Tout
                </button>
            </div>
        </div>

        <div class="category-tabs" id="categoryTabs"></div>
        <div id="categoryContent"></div>
    </div>

    <div id="saveIndicator" class="save-indicator"></div>

    <div id="footer-placeholder"></div>

    <script src="/public/js/include-partials.js"></script>
    <script src="/public/js/api.js"></script>
    <script>
        let configData = {};
        let configSchema = {};
        let unsavedChanges = new Set();

        async function loadConfig() {
            try {
                const data = await api.get('/api/config');
                configData = data.config;
                configSchema = data.schema;
                renderConfig();
            } catch (error) {
                console.error('Failed to load config:', error);
                showNotification('Erreur de chargement de la configuration', 'error');
            }
        }

        function renderConfig() {
            const categories = Object.keys(configSchema);
            
            // Render tabs
            const tabsHtml = categories.map(cat => `
                <button class="category-tab ${cat === categories[0] ? 'active' : ''}" 
                        onclick="switchCategory('${cat}')">
                    ${getCategoryIcon(cat)} ${getCategoryLabel(cat)}
                </button>
            `).join('');
            document.getElementById('categoryTabs').innerHTML = tabsHtml;

            // Render content
            const contentHtml = categories.map(cat => `
                <div class="category-content ${cat === categories[0] ? 'active' : ''}" 
                     id="category-${cat}">
                    <div class="category-header">
                        <h3>${getCategoryLabel(cat)}</h3>
                        <button class="reset-btn" onclick="resetCategory('${cat}')">
                            üîÑ R√©initialiser
                        </button>
                    </div>
                    <div class="config-grid">
                        ${renderCategoryFields(cat)}
                    </div>
                </div>
            `).join('');
            document.getElementById('categoryContent').innerHTML = contentHtml;
        }

        function renderCategoryFields(category) {
            const fields = configSchema[category];
            return Object.entries(fields).map(([key, schema]) => {
                const value = configData[category][key];
                const fieldId = `${category}.${key}`;
                const required = schema.required ? 'required-field' : '';

                let inputHtml = '';
                if (schema.type === 'boolean') {
                    inputHtml = `
                        <input type="checkbox" id="${fieldId}" ${value ? 'checked' : ''}
                               onchange="markChanged('${category}', '${key}', this.checked)">
                        <span>${getFieldLabel(key)}</span>
                    `;
                } else if (schema.type === 'password') {
                    inputHtml = `
                        <input type="password" id="${fieldId}" value="${value || ''}" 
                               placeholder="${schema.default}"
                               onchange="markChanged('${category}', '${key}', this.value)">
                    `;
                } else if (schema.type === 'number') {
                    const unit = schema.unit ? `<span>${schema.unit}</span>` : '';
                    inputHtml = `
                        <div class="value-unit">
                            <input type="number" id="${fieldId}" value="${value || schema.default}"
                                   min="${schema.min || 0}" max="${schema.max || 999999}"
                                   onchange="markChanged('${category}', '${key}', Number(this.value))">
                            ${unit}
                        </div>
                    `;
                } else if (schema.type === 'array') {
                    inputHtml = `
                        <input type="text" id="${fieldId}" 
                               value="${Array.isArray(value) ? value.join(', ') : ''}"
                               placeholder="Valeurs s√©par√©es par des virgules"
                               onchange="markChanged('${category}', '${key}', this.value.split(',').map(v => v.trim()))">
                    `;
                } else {
                    inputHtml = `
                        <input type="text" id="${fieldId}" value="${value || ''}" 
                               placeholder="${schema.default}"
                               onchange="markChanged('${category}', '${key}', this.value)">
                    `;
                }

                return `
                    <div class="config-item">
                        <label class="${required}">${getFieldLabel(key)}</label>
                        ${inputHtml}
                        ${getHelpText(key, schema)}
                    </div>
                `;
            }).join('');
        }

        function switchCategory(category) {
            // Update tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.category-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`category-${category}`).classList.add('active');
        }

        function markChanged(category, key, value) {
            configData[category][key] = value;
            unsavedChanges.add(`${category}.${key}`);
            
            // Auto-save apr√®s 1 seconde
            clearTimeout(window.autoSaveTimer);
            window.autoSaveTimer = setTimeout(() => {
                saveChanges(category, key, value);
            }, 1000);
        }

        async function saveChanges(category, key, value) {
            try {
                await api.put('/api/config', { category, key, value });
                unsavedChanges.delete(`${category}.${key}`);
                showNotification('‚úì Sauvegard√©', 'success');
            } catch (error) {
                console.error('Failed to save:', error);
                showNotification('Erreur de sauvegarde', 'error');
            }
        }

        async function saveAll() {
            if (unsavedChanges.size === 0) {
                showNotification('Aucun changement √† sauvegarder', 'success');
                return;
            }

            const updates = Array.from(unsavedChanges).map(key => {
                const [category, field] = key.split('.');
                return {
                    category,
                    key: field,
                    value: configData[category][field]
                };
            });

            try {
                await api.post('/api/config/bulk', { updates });
                unsavedChanges.clear();
                showNotification(`‚úì ${updates.length} param√®tres sauvegard√©s`, 'success');
            } catch (error) {
                console.error('Failed to save all:', error);
                showNotification('Erreur de sauvegarde', 'error');
            }
        }

        async function resetCategory(category) {
            if (!confirm(`R√©initialiser tous les param√®tres de ${getCategoryLabel(category)} ?`)) {
                return;
            }

            try {
                await api.post('/api/config/reset', { category });
                await loadConfig();
                showNotification('‚úì R√©initialis√©', 'success');
            } catch (error) {
                console.error('Failed to reset:', error);
                showNotification('Erreur', 'error');
            }
        }

        async function exportEnv() {
            window.location.href = '/api/config/export';
        }

        function showNotification(message, type = 'success') {
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = message;
            indicator.className = `save-indicator ${type}`;
            indicator.style.display = 'block';
            
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        function getCategoryIcon(category) {
            const icons = {
                database: 'üóÑÔ∏è',
                security: 'üîí',
                acme: 'üîê',
                botProtection: 'üõ°Ô∏è',
                backends: 'üñ•Ô∏è',
                alerts: 'üö®',
                ipSecurity: 'üö´',
                metrics: 'üìä'
            };
            return icons[category] || '‚öôÔ∏è';
        }

        function getCategoryLabel(category) {
            const labels = {
                database: 'Base de Donn√©es',
                security: 'S√©curit√© & JWT',
                acme: 'SSL / Let\'s Encrypt',
                botProtection: 'Protection Bot / DDoS',
                backends: 'Backends & Health Check',
                alerts: 'Alertes',
                ipSecurity: 'S√©curit√© IP',
                metrics: 'M√©triques'
            };
            return labels[category] || category;
        }

        function getFieldLabel(key) {
            const labels = {
                host: 'H√¥te',
                port: 'Port',
                user: 'Utilisateur',
                password: 'Mot de passe',
                name: 'Nom de la base',
                jwtSecret: 'Secret JWT',
                cookieSecure: 'Cookie s√©curis√© (HTTPS)',
                botSecret: 'Secret Bot Protection',
                email: 'Email ACME',
                localTlds: 'TLDs locaux',
                enabled: 'Activ√©',
                threshold: 'Seuil global (req/s)',
                perIpLimit: 'Limite par IP (req/min)',
                perIpLimitProtected: 'Limite domaines prot√©g√©s (req/min)',
                verifiedIpLimit: 'Limite IP v√©rifi√©es (req/min)',
                burstLimit: 'Limite burst (req/10s)',
                maxConnectionsPerIP: 'Connexions max par IP',
                maxAttempts: 'Tentatives max challenge',
                verificationDuration: 'Dur√©e v√©rification',
                challengeFirstVisit: 'Challenge 1√®re visite',
                healthCheckInterval: 'Intervalle health check',
                failureThreshold: 'Seuil d\'√©checs',
                healthCheckTimeout: 'Timeout health check',
                cooldown: 'D√©lai entre alertes',
                autoBlockIps: 'Blocage auto IPs',
                ipBytesThreshold: 'Seuil bytes par IP',
                ipRequestsThreshold: 'Seuil requ√™tes par IP',
                flushInterval: 'Intervalle flush m√©triques',
                maxBufferSize: 'Taille max buffer'
            };
            return labels[key] || key;
        }

        function getHelpText(key, schema) {
            const helps = {
                jwtSecret: 'Au moins 32 caract√®res al√©atoires',
                perIpLimit: 'Limite pour IPs non v√©rifi√©es',
                verifiedIpLimit: 'Limite plus √©lev√©e apr√®s challenge',
                verificationDuration: 'Dur√©e de validit√© apr√®s challenge r√©ussi',
                localTlds: 'Domaines locaux qui ne g√©n√®rent pas de certificat'
            };
            
            let text = helps[key] || '';
            if (schema.min !== undefined || schema.max !== undefined) {
                text += ` (${schema.min || 0} - ${schema.max || '‚àû'})`;
            }
            
            return text ? `<div class="help-text">${text}</div>` : '';
        }

        // Charger au d√©marrage
        loadConfig();

        // Avertir si changements non sauvegard√©s
        window.addEventListener('beforeunload', (e) => {
            if (unsavedChanges.size > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
